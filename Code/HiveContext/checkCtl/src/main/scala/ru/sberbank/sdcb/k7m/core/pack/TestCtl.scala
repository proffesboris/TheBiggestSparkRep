package ru.sberbank.sdcb.k7m.core.pack

import org.apache.spark.rdd.RDD
import org.apache.spark.sql.functions._
import org.apache.spark.sql.types.{StringType, StructField, StructType}
import org.apache.spark.sql.{Row, SparkSession}
import ru.sberbank.sdcb.k7m.java.CtlCheck

object TestCtl extends BaseMainClass {

  val IDS: Seq[Row] = Seq(Row("224108018"), Row("224108019"), Row("224108020"), Row("224108022"), Row("224108023"), Row("224108024"), Row("224108025"), Row("224108026"), Row("224108027"), Row("224108028"), Row("224108030"), Row("224108031"), Row("224108032"), Row("224108033"), Row("224108034"), Row("224108035"), Row("224108036"), Row("224108037"), Row("224108038"), Row("224108039"), Row("224108040"), Row("224108041"), Row("224108042"), Row("224108043"), Row("224108044"), Row("224108046"), Row("224108047"), Row("224108048"), Row("224108049"), Row("224108050"), Row("224108051"), Row("224108052"), Row("224108053"), Row("224108054"), Row("224108055"), Row("224108056"), Row("224108057"), Row("224108058"), Row("224108059"), Row("224108060"), Row("224108062"), Row("224108063"), Row("224108064"), Row("224108065"), Row("224108066"), Row("224108067"), Row("224108068"), Row("224108069"), Row("224108070"), Row("224108071"), Row("224108072"), Row("224108073"), Row("224108074"), Row("224108075"), Row("224108076"), Row("224108078"), Row("224108079"), Row("224108080"), Row("224108081"), Row("224108082"), Row("224108083"), Row("224108084"), Row("224108085"), Row("224108086"), Row("224108087"), Row("224108088"), Row("224108089"), Row("224108090"), Row("224108091"), Row("224108092"), Row("224108094"), Row("224108095"), Row("224108096"), Row("224109004"), Row("224109007"), Row("224109008"), Row("224109010"), Row("224109011"), Row("224109012"), Row("224109013"), Row("224109014"), Row("224109015"), Row("224109016"), Row("224109017"), Row("224110000"), Row("224110002"), Row("224110003"), Row("224110004"), Row("224110005"), Row("224110006"), Row("224110009"), Row("224110010"), Row("224110011"), Row("224110012"), Row("224110001"), Row("224110007"), Row("224110008"), Row("224101002"), Row("224104003"), Row("224108061"), Row("224108013"), Row("224101005"), Row("224101007"), Row("224101008"), Row("224101010"), Row("224101011"), Row("224101013"), Row("224101014"), Row("224101015"), Row("224102000"), Row("224102002"), Row("224102003"), Row("224102004"), Row("224102006"), Row("224101009"), Row("224101017"), Row("224102005"), Row("224103018"), Row("224104000"), Row("224108021"), Row("224109009"), Row("224101001"), Row("224101004"), Row("224102001"), Row("224103002"), Row("224104001"), Row("224109002"), Row("224100000"), Row("224101016"), Row("224104004"), Row("224108029"), Row("224101000"), Row("224109000"), Row("224101003"), Row("224104002"), Row("224105003"), Row("224105006"), Row("224107002"), Row("224101006"), Row("224109006"), Row("224101012"), Row("224103000"), Row("224103001"), Row("224103003"), Row("224103004"), Row("224103005"), Row("224103006"), Row("224103007"), Row("224103008"), Row("224103009"), Row("224103010"), Row("224103011"), Row("224103012"), Row("224103013"), Row("224103014"), Row("224103015"), Row("224103016"), Row("224103017"), Row("224103019"), Row("224103020"), Row("224103021"), Row("224103022"), Row("224103023"), Row("224103024"), Row("224103025"), Row("224103026"), Row("224103027"), Row("224103028"), Row("224103029"), Row("224103030"), Row("224103031"), Row("224103032"), Row("224103033"), Row("224103034"), Row("224103035"), Row("224103036"), Row("224103037"), Row("224103038"), Row("224103039"), Row("224103040"), Row("224103041"), Row("224103042"), Row("224103043"), Row("224103044"), Row("224103045"), Row("224103046"), Row("224103047"), Row("224103048"), Row("224103049"), Row("224103050"), Row("224103051"), Row("224103052"), Row("224103053"), Row("224103054"), Row("224103055"), Row("224103056"), Row("224103057"), Row("224103058"), Row("224103059"), Row("224103060"), Row("224103061"), Row("224103062"), Row("224103063"), Row("224103064"), Row("224103065"), Row("224103066"), Row("224103067"), Row("224103068"), Row("224103069"), Row("224103070"), Row("224103071"), Row("224104005"), Row("224108093"), Row("224109001"), Row("224105000"), Row("224105001"), Row("224105004"), Row("224105005"), Row("224105008"), Row("224105009"), Row("224105010"), Row("224105011"), Row("224105012"), Row("224105013"), Row("224105014"), Row("224105015"), Row("224105016"), Row("224105017"), Row("224105018"), Row("224105019"), Row("224105020"), Row("224105021"), Row("224105022"), Row("224105023"), Row("224105024"), Row("224105025"), Row("224105026"), Row("224105027"), Row("224105028"), Row("224105029"), Row("224105030"), Row("224105031"), Row("224105032"), Row("224105033"), Row("224105034"), Row("224105035"), Row("224105036"), Row("224105037"), Row("224105038"), Row("224105039"), Row("224105040"), Row("224105041"), Row("224105042"), Row("224105043"), Row("224105044"), Row("224105045"), Row("224105046"), Row("224105047"), Row("224105048"), Row("224105049"), Row("224105050"), Row("224105051"), Row("224105052"), Row("224105053"), Row("224105054"), Row("224105055"), Row("224105056"), Row("224105002"), Row("224109005"), Row("224105007"), Row("224105057"), Row("224105058"), Row("224105059"), Row("224105060"), Row("224105061"), Row("224105062"), Row("224105063"), Row("224105064"), Row("224105065"), Row("224105066"), Row("224105067"), Row("224105068"), Row("224105069"), Row("224105070"), Row("224105071"), Row("224106000"), Row("224106001"), Row("224106002"), Row("224106003"), Row("224106004"), Row("224106005"), Row("224106006"), Row("224108045"), Row("224108077"), Row("224109003"), Row("224106007"), Row("224106008"), Row("224106009"), Row("224106010"), Row("224106011"), Row("224106012"), Row("224106013"), Row("224106014"), Row("224106015"), Row("224106016"), Row("224106017"), Row("224106018"), Row("224106019"), Row("224106020"), Row("224106021"), Row("224106022"), Row("224106023"), Row("224106024"), Row("224106025"), Row("224106026"), Row("224106027"), Row("224106028"), Row("224106029"), Row("224106030"), Row("224106031"), Row("224106032"), Row("224106033"), Row("224107000"), Row("224107001"), Row("224107003"), Row("224107004"), Row("224107005"), Row("224107006"), Row("224107007"), Row("224107008"), Row("224107009"), Row("224107010"), Row("224107011"), Row("224107012"), Row("224107013"), Row("224107014"), Row("224108000"), Row("224108001"), Row("224108002"), Row("224108003"), Row("224108004"), Row("224108005"), Row("224108006"), Row("224108007"), Row("224108008"), Row("224108009"), Row("224108010"), Row("224108011"), Row("224108012"), Row("224108014"), Row("224108015"), Row("224108016"), Row("224108017"))

  override def run(params: Map[String, String], config: Config): Unit = {
    val spark = SparkSession
      .builder()
      .appName("CTL")
      .getOrCreate()

    val ctl = new CtlCheck()
    val ctlBctd = spark.sparkContext.broadcast(ctl).value
    val rdd : RDD[Row] = spark.sparkContext.parallelize(IDS)
    val schema = StructType(StructField("id", StringType, nullable = false)  :: Nil)
    val func = udf((id: String) => ctlBctd.check(id))
    val df = spark.createDataFrame(rdd, schema).withColumn("res", func(col("id")))
    df.write
      .format("parquet")
      .mode("overwrite")
      .option("path", s"${config.auxPath}test_ctl")
      .saveAsTable(s"${config.aux}.test_ctl")

  }
}
